let map;
let rotaAtual = null;
let pontosAtuais = [];
let localizacaoUsuario = null;

const rotas = {
  "Guaramirim/Jaraguá via Centro": {
    rota: [
      [-26.4687, -49.0021],
      [-26.4800, -49.0500],
      [-26.4900, -49.0687]
    ],
    pontos: [
      { nome: "Terminal Guaramirim", coords: [-26.4687, -49.0021] },
      { nome: "Ponto 1", coords: [-26.4750, -49.0200] },
      { nome: "Ponto 2", coords: [-26.4850, -49.0600] },
      { nome: "Centro Jaraguá", coords: [-26.4900, -49.0687] }
    ]
  },
  "Jaraguá/Guaramirim via Centro": {
    rota: [
      [-26.4786, -49.0852],
      [-26.4797, -49.0858],
      [-26.481315263856363, -49.08261381091635],
      [-26.48163446148541, -49.08222256024249],
      [-26.48335019046367, -49.080281501956726],
      [-26.482087389728402, -49.07840932007058],
      [-26.48191453381229, -49.07806063290369],
      [-26.48209144047052, -49.07721414579413],
      [-26.481739670806093, -49.075255529679445],
      [-26.479167449665827, -49.072358861691505],
      [-26.48165760582776, -49.07191888836502],
      [-26.482175095473288, -49.07178445559764],
      [-26.48220969604101, -49.07103862541268],
      [-26.48222629773684, -49.06872265209985],
<<<<<<< HEAD
      [-26.481687375810917, -49.06618073690684]
=======
      [-26.481687375810917, -49.06618073690684],
      [-26.480724621649586, -49.06177771539001],
      [-26.48001087645565, -49.058746882443714],
      [-26.479983742127704, -49.058426622635785],
      [-26.47991583668979, -49.056977613972144],
      [-26.47986151231407, -49.056173452092324],
      [-26.47948744016503, -49.054876092046214],
      [-26.479333265565646, -49.054694279027366],
      [-26.47917623566865, -49.054614536475235],
      [-26.47834825630295, -49.05456031153979],
      [-26.478228341551215, -49.054467810182615],
      [-26.478196935282128, -49.05425728984751],
      [-26.47816405698392, -49.05169552718335],
      [-26.478151708279604, -49.050097556659274],
      [-26.478094870136342, -49.049530809778524],
      [-26.478094870136342, -49.04903728331351],
      [-26.47795802112583, -49.04821920955883],
      [-26.477775555529778, -49.0477310475119],
      [-26.477590120148676, -49.046462922753335],
      [-26.477653782781033, -49.04627231362853],
      [-26.477639914188927, -49.04600758560822],
      [-26.477607080199412, -49.04562163165811],
      [-26.47763277636595, -49.04546533625593],
      [-26.477722712904317, -49.04527076443513],
      [-26.477786953245307, -49.045127227841306],
      [-26.477749836608233, -49.044977311843304],
      [-26.477664635171827, -49.044767902771355],
      [-26.4776703454287, -49.04427349894818],
      [-26.47762466336581, -49.04387957074067],
      [-26.47758611911114, -49.04366107614784],
      [-26.47762122997862, -49.04312334787436],
      [-26.477720142739834, -49.042187657724334],
      [-26.477818607487347, -49.04145177374881],
      [-26.477883118826533, -49.04082968625857],
      [-26.477952723127835, -49.040163976787404],
      [-26.478108908234177, -49.03918532696149],
      [-26.478173419412695, -49.03887617982953],
      [-26.478295288800073, -49.03801599625805],
      [-26.478503823732396, -49.036880424601456],
      [-26.47876372704381, -49.03512069560538],
      [-26.47878391565559, -49.03427715358166],
      [-26.47869927232263, -49.033840529223916],
      [-26.478449584092207, -49.03328262974393],
      [-26.478082253302546, -49.0327944677041],
      [-26.47766963011292, -49.03246004110413],
      [-26.477592389366812, -49.03240172891665],
      [-26.477023596532916, -49.0321159901524],
      [-26.476631432001962, -49.03196236489071],
      [-26.476492221765795, -49.031871327693764],
      [-26.476212103085636, -49.03170821938853],
      [-26.475692715665815, -49.031385823608375],
      [-26.475458196437764, -49.031163385652235],
      [-26.475250517240926, -49.03091394021071],
      [-26.475036835359543, -49.030519655483346],
      [-26.47490838594933, -49.03015889836977],
      [-26.47479710877444, -49.029542615411934],
      [-26.474756293004383, -49.02892704844189],
      [-26.47471067536144, -49.0285354459267],
      [-26.47463173341077, -49.02749459607854],
      [-26.47456178089522, -49.026435255939816],
      [-26.474506294654358, -49.02573460000579],
      [-26.474219687457108, -49.02240560586389],
      [-26.474165715050486, -49.021647536924554],
      [-26.474191896908142, -49.02126200670457],
      [-26.474167485809495, -49.020919955251664],
      [-26.474341030427716, -49.0200918059751],
      [-26.474410596130618, -49.019738013360225],
      [-26.474602438065926, -49.01900402599498],
      [-26.475025489490942, -49.018124078383096],
      [-26.47533822923458, -49.01759603195988],
      [-26.47576569544732, -49.016836636064596],
      [-26.476100365958395, -49.016283735056646],
      [-26.476164733983936, -49.01616348686422],
      [-26.476309138927753, -49.015809759621966],
      [-26.476610036667395, -49.01528873643171],
      [-26.47684725708742, -49.014875987262634],
      [-26.477185330861165, -49.01429351690202],
      [-26.477736320201412, -49.01332690472548],
      [-26.478239618238067, -49.01244522207188],
      [-26.47861122299397, -49.01178375606224],
      [-26.478765709550473, -49.01161116471606],
      [-26.478867568704608, -49.011426245415386],
      [-26.479032933201253, -49.010974947196054],
      [-26.479266156435447, -49.01022790159665],
      [-26.479441744263074, -49.00943845034029],
      [-26.479567382533567, -49.007856007408634],
      [-26.479508559126526, -49.007562784405394],
      [-26.479526773282675, -49.005725395128074],
      [-26.47954292406747, -49.004414972906645],
      [-26.47953282982747, -49.00311131705429],
      [-26.479470245523842, -49.00254970753257],
      [-26.479207731671682, -49.00134814697233],
      [-26.47865230743848, -48.99997668957502],
      [-26.478045121033386, -48.99857601907293],
      [-26.47784870690803, -48.99816319088956],
      [-26.477494066964123, -48.99738932441202],
      [-26.476736983063883, -48.99569772944966],
      [-26.47621987074397, -48.99456398590286],
      [-26.475727720532138, -48.9933687792864],
      [-26.475556501252964, -48.99276785252216],
      [-26.475484473890702, -48.9923601567467],
      [-26.475443217705966, -48.99180239282738],
      [-26.47540926365177, -48.991227720548935],
      [-26.475414185807477, -48.99066297631927],
      [-26.4754209766178, -48.99045434942098],
      [-26.475475303091862, -48.99010347690552],
      [-26.47548548930268, -48.98982467550009],
      [-26.475443046749906, -48.989568633394256],
      [-26.475431393004303, -48.98879689445725],
      [-26.475438530964315, -48.987964382224945],
      [-26.475444241331438, -48.98721480224631],
      [-26.47544195153191, -48.98529475821609],
      [-26.4754448817205, -48.983963965373604],
      [-26.47542064613285, -48.98331555513449],
      [-26.475347838912256, -48.98266810399672],
      [-26.475226770798415, -48.98212791904273],
      [-26.47503245681767, -48.98140366870561],
      [-26.474850889404767, -48.98086625968092],
      [-26.474556981064616, -48.97999243566144],
      [-26.474492738917682, -48.97981062264864],
      [-26.47446133163276, -48.97960329201478],
      [-26.474371392543155, -48.979378418021966],
      
    
      
    
     
       
      
     
      
    
    
      
      
      
     

>>>>>>> 61cdbdc (commit)
    ],
    pontos: [
      { nome: "Terminal Jaraguá", coords: [-26.4786, -49.0852] },
      { nome: "Ponto Banco do Brasil", coords: [-26.48163446148541, -49.08222256024249] },
      { nome: "Ponto Igreja", coords: [-26.48209144047052, -49.07721414579413] },
      { nome: "Ponto Fort", coords: [-26.481616752256866, -49.075035868689696] },
      { nome: "Ponto Multimotors", coords: [-26.47974033714948, -49.072259426825994] },
      { nome: "Ponto Big Dog Brasil", coords: [-26.48220969604101, -49.07103862541268] },
<<<<<<< HEAD
      { nome: "Ponto Marisol", coords: [-26.481687375810917, -49.06618073690684] }
=======
      { nome: "Ponto Marisol", coords: [-26.481687375810917, -49.06618073690684] },
      { nome: "Ponto BalMec", coords: [ -26.480724621649586, -49.06177771539001]},
      { nome: "Ponto Lotérica Baependi", coords: [-26.48001087645565, -49.058746882443714]},
      { nome: "Ponto WEG Portaria 21", coords: [-26.47816405698392, -49.05169552718335]},
      { nome: "Ponto WEG Portaria 23", coords: [-26.4776703454287, -49.04427349894818]},
      { nome: "Ponto Viaduto", coords: [-26.478503823732396, -49.036880424601456]},
      { nome: "Ponto Vonpar", coords: [-26.474232317613524, -49.021275850589355]},
      { nome: "Ponto Costello", coords: [-26.47576569544732, -49.016836636064596]},
      { nome: "Ponto Enfrente Benner", coords: [-26.479567382533567, -49.007856007408634]},
      { nome: "Ponto Vilmar Demolições", coords: [-26.475520289411524, -48.989819062717345]},
      { nome: "Ponto MMG Caminhões", coords: [-26.474404624515884, -48.979360033551764]},
      { nome: "Ponto Transluc", coords: [-26.477592389366812, -49.03240172891665]},
      
>>>>>>> 61cdbdc (commit)
    ]
  },
  "Guaramirim/Jaraguá via Corticeira": {
    rota: [
      [-26.4687, -49.0021],
      [-26.4700, -49.0300],
      [-26.4900, -49.0687]
    ],
    pontos: [
      { nome: "Terminal Guaramirim", coords: [-26.4687, -49.0021] },
      { nome: "Ponto Corticeira", coords: [-26.4700, -49.0300] },
      { nome: "Centro Jaraguá", coords: [-26.4900, -49.0687] }
    ]
  },
  "Jaraguá/Guaramirim via Corticeira": {
    rota: [
      [-26.4900, -49.0687],
      [-26.4700, -49.0300],
      [-26.4687, -49.0021],
      [37.24804, -115.800155]
    ],
    pontos: [
      { nome: "Centro Jaraguá", coords: [-26.4900, -49.0687] },
      { nome: "Ponto Corticeira", coords: [-26.4700, -49.0300] },
      { nome: "Terminal Guaramirim", coords: [-26.4687, -49.0021] }
    ]
  }
};

function initMap() {
  map = L.map('map').setView([-26.4900, -49.0687], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  pedirLocalizacao();

  const seletor = document.getElementById('rota');
  seletor.addEventListener('change', function () {
    const rotaSelecionada = this.value;
    if (rotas[rotaSelecionada]) {
      desenharRota(rotaSelecionada);
    }
  });
}

function desenharRota(nomeRota) {
  // Remove rota anterior
  if (rotaAtual) {
    map.removeLayer(rotaAtual);
  }

  pontosAtuais.forEach(p => map.removeLayer(p));
  pontosAtuais = [];

  const rota = rotas[nomeRota].rota;
  const pontos = rotas[nomeRota].pontos;

  // Linha da rota
  rotaAtual = L.polyline(rota, {
    color: '#00caf8',
    weight: 5
  }).addTo(map);

  map.fitBounds(rotaAtual.getBounds());

  // Apenas bolinhas nos extremos da rota
  [0, rota.length - 1].forEach(i => {
    const marker = L.circleMarker(rota[i], {
      radius: 8,
      color: '#0d47a1',
      fillColor: '#42a5f5',
      fillOpacity: 0.8
    }).addTo(map);
    pontosAtuais.push(marker);
  });

  // Pontos de ônibus com nome
  pontos.forEach(p => {
    const marker = L.marker(p.coords)
      .addTo(map)
      .bindPopup(p.nome);
    pontosAtuais.push(marker);
  });
}

function pedirLocalizacao() {
  if (!navigator.geolocation) {
    alert("Geolocalização não suportada pelo navegador.");
    return;
  }

  navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude } = pos.coords;

    if (localizacaoUsuario) {
      localizacaoUsuario.setLatLng([latitude, longitude]);
    } else {
      localizacaoUsuario = L.circleMarker([latitude, longitude], {
        radius: 8,
        color: '#2196f3',
        fillColor: '#2196f3',
        fillOpacity: 0.9
      }).addTo(map).bindPopup("Você está aqui").openPopup();
    }
  }, () => {
    alert("Não foi possível obter sua localização.");
  }, {
    enableHighAccuracy: true
  });
}

window.onload = initMap;
